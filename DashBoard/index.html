<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" sizes="32x32" href="./Logo.png">
    <title>H·ªá Th·ªëng Gi√°m S√°t V√† ƒêi·ªÅu Khi·ªÉn Giao C·∫Øt ƒê∆∞·ªùng S·∫Øt Th√¥ng Minh</title>
    <link rel="stylesheet" href="./styles.css">
    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- jsPDF and html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- docx -->
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <!-- MQTT.js for HiveMQ WebSocket -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/5.3.0/mqtt.min.js"></script>
    <!-- WebLLM - Load from esm.run -->
    <script type="module">
      import * as webllm from 'https://esm.run/@mlc-ai/web-llm';
      window.MLCEngine = webllm.MLCEngine;
      window.webllm = webllm;
    </script>
    <style>
      /* Login Modal */
      #loginModal {
        display: flex;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }
      
      #loginModal.hidden {
        display: none;
      }
      
      .login-container {
        background: white;
        padding: 40px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 400px;
      }
      
      .login-container h2 {
        text-align: center;
        margin-bottom: 30px;
        color: #333;
      }
      
      .login-form input {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        box-sizing: border-box;
      }
      
      .login-form button {
        width: 100%;
        padding: 10px;
        background: #51b848;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
      }
      
      .login-form button:hover {
        background: #3a9230;
      }
      
      .login-error {
        color: red;
        text-align: center;
        margin-bottom: 15px;
        font-size: 14px;
      }
      
      /* Left sidebar menu */
      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        width: 200px;
        height: 100%;
        background: #2c3e50;
        color: white;
        padding-top: 20px;
        z-index: 500;
        overflow-y: auto;
        display: none;
      }
      
      .sidebar.active {
        display: flex;
        flex-direction: column;
      }
      
      .sidebar-header {
        padding: 15px 20px;
        border-bottom: 1px solid #34495e;
        margin-bottom: 20px;
      }
      
      .sidebar-header p {
        margin: 0;
        font-size: 14px;
        color: #bdc3c7;
      }
      
      .sidebar-user {
        font-weight: bold;
        color: white;
        font-size: 14px;
      }
      
      .sidebar-station {
        font-size: 11px;
        color: #95a5a6;
        margin-top: 5px;
        display: flex;
        flex-direction: column;
        gap: 3px;
      }
      
      .station-line {
        padding: 2px 0;
        line-height: 1.3;
      }
      
      .sidebar-menu {
        flex: 1;
      }
      
      .sidebar-menu a {
        display: block;
        padding: 12px 20px;
        color: #bdc3c7;
        text-decoration: none;
        border-left: 3px solid transparent;
        transition: all 0.3s;
      }
      
      .sidebar-menu a:hover {
        background: #34495e;
        color: white;
      }
      
      .sidebar-menu a.active {
        background: #51b848;
        color: white;
        border-left-color: #51b848;
      }
      
      .sidebar-footer {
        padding: 15px 20px;
        border-top: 1px solid #34495e;
      }
      
      .sidebar-footer button {
        width: 100%;
        padding: 10px;
        background: #e74c3c;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }
      
      .sidebar-footer button:hover {
        background: #c0392b;
      }
      
      /* Main content shift */
      body.sidebar-active {
        margin-left: 200px;
      }
      
      body.sidebar-active header,
      body.sidebar-active .nav-bar,
      body.sidebar-active > div[id^="section"] {
        margin-left: 0;
      }
      
      .toggle-sidebar-btn {
        display: block;
        position: fixed;
        top: 20px;
        left: 20px;
        background: #2c3e50;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        z-index: 400;
        transition: all 0.3s;
      }
      
      body.sidebar-active .toggle-sidebar-btn {
        left: 220px;
      }
      
      /* Infinite scroll loader */
      #loadingIndicator {
        text-align: center;
        padding: 20px;
        display: none;
      }
      
      #loadingIndicator.show {
        display: block;
      }
      
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #51b848;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <!-- Login Modal -->
    <div id="loginModal">
      <div class="login-container">
        <h2>ƒêƒÉng Nh·∫≠p</h2>
        <div class="login-error" id="loginError"></div>
        <form class="login-form" id="loginForm">
          <input type="text" id="loginUsername" placeholder="T√™n ƒëƒÉng nh·∫≠p" required>
          <input type="password" id="loginPassword" placeholder="M·∫≠t kh·∫©u" required>
          <button type="submit">ƒêƒÉng Nh·∫≠p</button>
        </form>
      </div>
    </div>

    <!-- Left Sidebar Menu -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-user" id="sidebarUsername"></div>
        <div class="sidebar-station" id="sidebarStation"></div>
      </div>
      <nav class="sidebar-menu">
        <a href="#" data-section="sectionHoSoTau">üìä Th√¥ng Tin T√†u</a>
        <a href="#" data-section="sectionPhanTich">üìà Ph√¢n T√≠ch D·ªØ Li·ªáu</a>
        <a href="#" data-section="sectionBangDieuKhien">‚öôÔ∏è B·∫£ng ƒêi·ªÅu Khi·ªÉn</a>
      </nav>
      <div class="sidebar-footer">
        <button id="logoutBtn">üö™ ƒêƒÉng Xu·∫•t</button>
      </div>
    </div>

    <button class="toggle-sidebar-btn" id="toggleSidebar">‚ò∞</button>
    
    <header>
      <a href="../LandingPage/index.html" class="logo-link">
        <img src="./Logo.png" alt="Logo">
      </a>
      <div>
        <div class="banner">ƒê∆Ø·ªúNG S·∫ÆT VI·ªÜT NAM</div>
        <div class="banner">H·ªá Th·ªëng Gi√°m S√°t V√† ƒêi·ªÅu Khi·ªÉn Giao C·∫Øt ƒê∆∞·ªùng S·∫Øt Th√¥ng Minh</div>
      </div>
      <img src="./Train.png" alt="Train" style="transform: scaleX(-1);">
    </header>
    <div class="nav-bar">
      <button>Th√¥ng Tin T√†u</button>
      <button>Ph√¢n t√≠ch d·ªØ li·ªáu</button>
      <button>B·∫£ng ƒêi·ªÅu Khi·ªÉn</button>
    </div>
    <div id="sectionHoSoTau">
      <h1>Th√¥ng Tin T√†u</h1>
      <div class="controls">
        <input type="text" id="searchInput" placeholder="Search..." />
        <select id="filterTenTau">
          <option value="">T·∫•t C·∫£ T√™n T√†u</option>
        </select>
        <select id="filterTuyen">
          <option value="">T·∫•t C·∫£ Tuy·∫øn</option>
        </select>
        <select id="speedUnit">
          <option value="kmh">V·∫≠n T·ªëc: km/gi·ªù</option>
          <option value="mh">V·∫≠n T·ªëc: m/gi·ªù</option>
          <option value="ms">V·∫≠n T·ªëc: m/gi√¢y</option>
          <option value="cms">V·∫≠n T·ªëc: cm/gi√¢y</option>
        </select>
        <input type="date" id="dateFrom" />
        <input type="date" id="dateTo" />
        <input type="time" id="timeFrom" />
        <input type="time" id="timeTo" />
        <button id="exportExcel">Xu·∫•t file Excel</button>
        <button id="exportPDF">Xu·∫•t file PDF</button>
        <button id="exportDOCX">Xu·∫•t file B√°o c√°o</button>
      </div>
      <table id="trainTable">
        <thead>
          <tr>
            <th data-key="STT">STT</th>
            <th data-key="T√™n T√†u">T√™n T√†u</th>
            <th data-key="Tuy·∫øn">Tuy·∫øn</th>
            <th data-key="Tr·∫°m">Tr·∫°m</th>
            <th data-key="V·∫≠n T·ªëc">V·∫≠n T·ªëc</th>
            <th>Ng√†y ƒê·∫øn</th>
            <th>Gi·ªù ƒê·∫øn</th>
            <th>Ng√†y R·ªùi</th>
            <th>Gi·ªù R·ªùi</th>
            <th data-key="Tr·∫°ng Th√°i">Tr·∫°ng Th√°i</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="loadingIndicator">
        <div class="spinner"></div>
        <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
      </div>
    </div>
    <div id="sectionPhanTich" style="display:none;">
      <h1>üìä Ph√¢n T√≠ch D·ªØ Li·ªáu</h1>
      
      <!-- Data Loading Controls -->
      <div class="data-loading-section">
        <div class="data-info">
          <span id="dataLoadingStatus">ƒê√£ t·∫£i: <strong id="dataCountDisplay">0</strong> b·∫£n ghi</span>
          <button id="loadMoreDataBtn" class="btn-load-more">üì• T·∫£i Th√™m D·ªØ Li·ªáu</button>
        </div>
      </div>
      
      <!-- Main Analysis Section -->
      <div class="analysis-main-container">
        <div class="analysis-filters">
          <div class="filter-group">
            <label for="analysisChartType">Lo·∫°i Bi·ªÉu ƒê·ªì:</label>
            <select id="analysisChartType">
              <option value="avgSpeed">T·ªëc ƒê·ªô Trung B√¨nh</option>
              <option value="tripCount">S·ªë Chuy·∫øn</option>
              <option value="speedPerDay">T·ªëc ƒê·ªô Theo Ng√†y</option>
              <option value="speedComparison">So S√°nh T·ªëc ƒê·ªô</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="analysisTrainFilter">T√†u:</label>
            <select id="analysisTrainFilter">
              <option value="">T·∫•t C·∫£</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="analysisStationFilter">Tr·∫°m:</label>
            <select id="analysisStationFilter">
              <option value="">T·∫•t C·∫£</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="analysisDateFrom">T·ª´ Ng√†y:</label>
            <input type="date" id="analysisDateFrom">
          </div>
          <div class="filter-group">
            <label for="analysisDateTo">ƒê·∫øn Ng√†y:</label>
            <input type="date" id="analysisDateTo">
          </div>
          <button id="analysisApplyFilters" class="btn-apply-filters">üîÑ √Åp D·ª•ng</button>
        </div>
        
        <div class="analysis-main-chart">
          <canvas id="mainAnalysisChart" height="100"></canvas>
        </div>
      </div>

      <!-- Station-Based Charts Section -->
      <div class="station-charts-section">
        <h2>üìç Ph√¢n T√≠ch Theo Tr·∫°m</h2>
        <div id="stationChartsContainer" class="station-charts-grid">
          <!-- Station charts will be dynamically inserted here -->
        </div>
      </div>
    </div>
    <div id="sectionBangDieuKhien" style="display:none;">
      <h1>‚öôÔ∏è B·∫£ng ƒêi·ªÅu Khi·ªÉn</h1>
      
      <!-- MQTT Connection Status -->
      <div class="mqtt-status-section">
        <div class="mqtt-status-indicator">
          <span class="status-dot" id="mqttStatusDot"></span>
          <span id="mqttStatusText">ƒêang k·∫øt n·ªëi MQTT...</span>
        </div>
      </div>
      
      <!-- Station Controls Container -->
      <div id="stationControlsContainer"></div>
    </div>

    <!-- AI Agent Widget (Bottom Right) -->
    <div id="aiAgentWidget" class="ai-agent-widget">
      <div class="ai-agent-header">
        <span class="ai-agent-title">ü§ñ Tr·ª£ L√Ω Ph√¢n T√≠ch D·ªØ Li·ªáu</span>
        <button id="aiToggleBtn" class="ai-toggle-btn" title="·∫®n/Hi·ªán">‚àí</button>
      </div>
      <div id="aiChatContainer" class="ai-chat-container">
        <div id="aiMessages" class="ai-messages"></div>
        <div id="aiLoadingIndicator" class="ai-loading" style="display: none;">
          <div class="ai-spinner"></div>
        </div>
      </div>
      <div class="ai-input-section">
        <input 
          type="text" 
          id="aiInput" 
          class="ai-input" 
          placeholder="H·ªèi v·ªÅ d·ªØ li·ªáu..."
          disabled
        />
        <button id="aiSendBtn" class="ai-send-btn" disabled>G·ª≠i</button>
      </div>
      <div id="aiStatus" class="ai-status">ƒêang t·∫£i m√¥ h√¨nh...</div>
    </div>

    <script defer src="./script.js"></script>
  </body>
</html>
