<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Hệ Thống Giám Sát Đường Tàu FPT</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #f9f9f9;
    color: #333;
  }
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #ffffff;
    padding: 10px 20px;
    color: #333;
    position: relative;
  }
  header img {
    height: 50px;
  }
  header .banner {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    font-size: 20px;
    font-weight: bold;
  }
  .nav-bar {
    display: flex;
    justify-content: center;
    background-color: #FFD580;
    border-top: 2px solid #000000;
    border-bottom: 2px solid #000000;
  }
  .nav-bar button {
    background: #ffffff;
    color: #333;
    border: 2px solid #000000;
    padding: 12px 20px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.3s, border-color 0.3s;
  }
  .nav-bar button:hover {
    background: #e6e6e6;
    border-color: #999;
  }
  h1 {
    text-align: center;
    color: #ffffff;
    background-color: #FF6600;
    padding: 20px 0;
    margin-top: 0;
  }
  .controls {
    margin: 15px auto;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
  }
  .controls input, .controls select, .controls button {
    padding: 6px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  .controls button {
    background: #FF6600;
    color: #fff;
    border: none;
    cursor: pointer;
  }
  .controls button:hover {
    background: #e65c00;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 20px;
  }
  th, td {
    padding: 8px;
    border: 1px solid #eee;
    text-align: center;
  }
  th {
    background: #FF6600;
    color: #fff;
    cursor: pointer;
  }
  tr:hover {
    background: #fff4eb;
  }
</style>
<!-- SheetJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- jsPDF and html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>

<header>
  <img src="./FPT_Train_logo.svg_2.png" alt="Logo">
  <div class="banner">Hệ Thống Giám Sát Đường Tàu FPT</div>
</header>

<div class="nav-bar">
  <button>Hồ sơ tàu</button>
  <button>Phân tích dữ liệu</button>
  <button>Bảng Điều Khiển</button>
</div>

<h1>Hồ Sơ Tàu</h1>

<div class="controls">
  <input type="text" id="searchInput" placeholder="Search..." />
  <select id="filterTenTau">
    <option value="">Tất Cả Tên Tàu</option>
  </select>
  <select id="filterTuyen">
    <option value="">Tất Cả Tuyến</option>
  </select>
  <select id="speedUnit">
    <option value="kmh">Vận Tốc: km/giờ</option>
    <option value="mh">Vận Tốc: m/giờ</option>
    <option value="ms">Vận Tốc: m/giây</option>
  </select>
  <input type="date" id="dateFrom" />
  <input type="date" id="dateTo" />
  <input type="time" id="timeFrom" />
  <input type="time" id="timeTo" />
  <button id="servoClose">Servo Close</button>
  <button id="servoOpen">Servo Open</button>
  <button id="exportExcel">Export Excel</button>
  <button id="exportPDF">Export PDF</button>
</div>

<table id="trainTable">
  <thead>
    <tr>
      <th data-key="STT">STT</th>
      <th data-key="Tên Tàu">Tên Tàu</th>
      <th data-key="Tuyến">Tuyến</th>
      <th data-key="Trạm">Trạm</th>
      <th data-key="Vận Tốc">Vận Tốc</th>
      <th>Ngày Đến</th>
      <th>Giờ Đến</th>
      <th>Ngày Rời</th>
      <th>Giờ Rời</th>
      <th data-key="Trạng Thái">Trạng Thái</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbwGCqdZvb9hlHfwJUFRlfpgBfkXtdBSKRVxxUZX2MzYw4M-kTud7w9aK7Ilm_d0PXAoyQ/exec";
let originalData = [];
let currentFilteredData = [];
let currentSort = { key: "", asc: true };
let ws = null;

function applySavedUnits() {
  const savedSpeedUnit = localStorage.getItem("speedUnit");
  if (savedSpeedUnit) document.getElementById("speedUnit").value = savedSpeedUnit;
}

async function fetchDataAndRender() {
  try {
    const res = await fetch(GAS_URL + "?t=" + Date.now());
    const json = await res.json();
    if (json.status === "success") {
      originalData = json.data;
      currentFilteredData = originalData;
      populateFilters();
      renderTable(originalData);
    }
  } catch (err) {
    console.error("Error fetching train data:", err);
  }
}

function populateFilters() {
  const tenTauSelect = document.getElementById("filterTenTau");
  const tuyenSelect = document.getElementById("filterTuyen");
  const tenTauSet = new Set();
  const tuyenSet = new Set();

  originalData.forEach(item => {
    tenTauSet.add(item["Tên Tàu"]);
    tuyenSet.add(item["Tuyến"]);
  });

  tenTauSelect.innerHTML = `<option value="">All Tên Tàu</option>`;
  tuyenSelect.innerHTML = `<option value="">All Tuyến</option>`;
  tenTauSet.forEach(val => {
    tenTauSelect.innerHTML += `<option value="${val}">${val}</option>`;
  });
  tuyenSet.forEach(val => {
    tuyenSelect.innerHTML += `<option value="${val}">${val}</option>`;
  });
}

function renderTable(data) {
  currentFilteredData = data;
  const tbody = document.querySelector("#trainTable tbody");
  tbody.innerHTML = "";
  const speedUnit = document.getElementById("speedUnit").value;

  data.forEach(row => {
    let speed = Number(row["Vận Tốc"]);
    if (speedUnit === "kmh") {
      speed = speed.toFixed(2) + " km/h";
    } else if (speedUnit === "mh") {
      speed = (speed * 1000).toFixed(2) + " m/h";
    } else if (speedUnit === "ms") {
      speed = (speed * 1000 / 3600).toFixed(2) + " m/s";
    }

    const ngayDen = new Date(row["Ngày Đến"]).toLocaleDateString();
    const gioDen = new Date(row["Giờ Đến"]).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit', second: '2-digit'});
    const ngayRoi = new Date(row["Ngày Rời"]).toLocaleDateString();
    const gioRoi = new Date(row["Giờ Rời"]).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit', second: '2-digit'});

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row["STT"]}</td>
      <td>${row["Tên Tàu"]}</td>
      <td>${row["Tuyến"]}</td>
      <td>${row["Trạm"]}</td>
      <td>${speed}</td>
      <td>${ngayDen}</td>
      <td>${gioDen}</td>
      <td>${ngayRoi}</td>
      <td>${gioRoi}</td>
      <td>${row["Trạng Thái"]}</td>
    `;
    tbody.appendChild(tr);
  });
}

function filterAndSearch() {
  const searchValue = document.getElementById("searchInput").value.toLowerCase();
  const tenTauFilter = document.getElementById("filterTenTau").value;
  const tuyenFilter = document.getElementById("filterTuyen").value;
  const dateFromValue = document.getElementById("dateFrom").value;
  const dateToValue = document.getElementById("dateTo").value;
  const timeFromValue = document.getElementById("timeFrom").value;
  const timeToValue = document.getElementById("timeTo").value;

  const filtered = originalData.filter(item => {
    const matchSearch = Object.values(item).some(val =>
      String(val).toLowerCase().includes(searchValue)
    );
    const matchTenTau = !tenTauFilter || item["Tên Tàu"] === tenTauFilter;
    const matchTuyen = !tuyenFilter || item["Tuyến"] === tuyenFilter;
    let matchDateTime = true;

    if (dateFromValue || dateToValue || timeFromValue || timeToValue) {
      const date = new Date(item["Ngày Đến"]);
      const time = new Date(item["Giờ Đến"]);
      const combinedDateTime = new Date(
        date.getFullYear(), date.getMonth(), date.getDate(),
        time.getHours(), time.getMinutes(), time.getSeconds()
      );
      if (dateFromValue) {
        const dateFrom = new Date(dateFromValue);
        if (combinedDateTime < dateFrom) matchDateTime = false;
      }
      if (dateToValue) {
        const dateTo = new Date(dateToValue);
        dateTo.setHours(23,59,59,999);
        if (combinedDateTime > dateTo) matchDateTime = false;
      }
      if (timeFromValue) {
        const [h,m] = timeFromValue.split(":");
        if (combinedDateTime.getHours() < +h || (combinedDateTime.getHours() === +h && combinedDateTime.getMinutes() < +m)) {
          matchDateTime = false;
        }
      }
      if (timeToValue) {
        const [h,m] = timeToValue.split(":");
        if (combinedDateTime.getHours() > +h || (combinedDateTime.getHours() === +h && combinedDateTime.getMinutes() > +m)) {
          matchDateTime = false;
        }
      }
    }
    return matchSearch && matchTenTau && matchTuyen && matchDateTime;
  });

  renderTable(filtered);
}

function sortBy(key) {
  const asc = currentSort.key === key ? !currentSort.asc : true;
  currentSort = { key, asc };

  const sorted = [...currentFilteredData].sort((a, b) => {
    let valA = a[key];
    let valB = b[key];
    if (!isNaN(valA) && !isNaN(valB)) {
      valA = Number(valA);
      valB = Number(valB);
    }
    return asc ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
  });

  renderTable(sorted);
}

function setupWebSocket() {
  ws = new WebSocket("wss://durable-chat-template.templates.workers.dev/parties/chat/FPTTrainWSS");
  ws.onopen = () => console.log("WebSocket connected.");
  ws.onmessage = (event) => {
    console.log("WebSocket message received:", event.data);
    if (event.data === "front-end update") {
      fetchDataAndRender();
    }
  };
  ws.onclose = () => {
    console.warn("WebSocket disconnected. Reconnecting in 5s...");
    setTimeout(setupWebSocket, 5000);
  };
  ws.onerror = (err) => {
    console.error("WebSocket error:", err);
    ws.close();
  };
}

function exportExcel() {
  const ws_data = [
    ["STT","Tên Tàu","Tuyến","Trạm","Vận Tốc","Ngày Đến","Giờ Đến","Ngày Rời","Giờ Rời","Trạng Thái"],
    ...currentFilteredData.map(row => [
      row["STT"],
      row["Tên Tàu"],
      row["Tuyến"],
      row["Trạm"],
      row["Vận Tốc"],
      row["Ngày Đến"],
      row["Giờ Đến"],
      row["Ngày Rời"],
      row["Giờ Rời"],
      row["Trạng Thái"]
    ])
  ];
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws, "Data");
  XLSX.writeFile(wb, "TrainData.xlsx");
}

async function exportPDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('l', 'pt', 'a4');
  const table = document.querySelector("#trainTable");
  await html2canvas(table).then(canvas => {
    const imgData = canvas.toDataURL('image/png');
    const imgProps= pdf.getImageProperties(imgData);
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
    pdf.save("TrainData.pdf");
  });
}

document.getElementById("servoClose").addEventListener("click", () => {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send("servo close");
  }
});
document.getElementById("servoOpen").addEventListener("click", () => {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send("servo open");
  }
});

document.getElementById("searchInput").addEventListener("input", filterAndSearch);
document.getElementById("filterTenTau").addEventListener("change", filterAndSearch);
document.getElementById("filterTuyen").addEventListener("change", filterAndSearch);
document.getElementById("speedUnit").addEventListener("change", () => {
  localStorage.setItem("speedUnit", document.getElementById("speedUnit").value);
  renderTable(currentFilteredData);
});
document.getElementById("dateFrom").addEventListener("change", filterAndSearch);
document.getElementById("dateTo").addEventListener("change", filterAndSearch);
document.getElementById("timeFrom").addEventListener("change", filterAndSearch);
document.getElementById("timeTo").addEventListener("change", filterAndSearch);
document.querySelectorAll("#trainTable th").forEach(th => {
  th.addEventListener("click", () => sortBy(th.dataset.key));
});
document.getElementById("exportExcel").addEventListener("click", exportExcel);
document.getElementById("exportPDF").addEventListener("click", exportPDF);

applySavedUnits();
fetchDataAndRender();
setupWebSocket();
setInterval(fetchDataAndRender, 2000);
</script>

</body>
</html>
