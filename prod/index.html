<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>FPT Train Control</title>
	<style>
		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background: #f4f4f4;
			margin: 0;
			padding: 0;
		}
		header {
			background: #0072c6;
			color: white;
			padding: 10px 0;
			text-align: center;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
		}
		h1 {
			margin: 0;
		}
		#svg {
			background: white;
			border: 1px solid #ccc;
			margin: 20px auto;
			display: block;
		}
		table {
			margin: 0 auto 30px;
			border-collapse: collapse;
			width: 90%;
			background: #fff;
			box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
		}
		table th, table td {
			border: 1px solid #ccc;
			padding: 8px 12px;
			text-align: center;
		}
		table th {
			background: #0072c6;
			color: white;
		}
	</style>
</head>
<body>
	<header>
		<h1>FPT Train Control</h1>
		<h2>Train Speed: <span id="speed">0</span> px/s</h2>
	</header>

	<svg id="svg" width="600" height="600"></svg>

	<table>
		<thead>
			<tr>
				<th>Source</th>
				<th>Speed (px/s)</th>
				<th>Timestamp</th>
				<th>Intersection Countdown (s)</th>
				<th>Intersection Status</th>
			</tr>
		</thead>
		<tbody id="log-table"></tbody>
	</table>

	<script>
		const svg = document.getElementById("svg");
		const speedEl = document.getElementById("speed");
		const logTable = document.getElementById("log-table");

		const latestLogs = {};

		function updateLogTable() {
			logTable.innerHTML = '';
			Object.values(latestLogs).forEach(log => {
				const row = document.createElement('tr');
				row.innerHTML = `
					<td>${log.source}</td>
					<td>${log.speed.toFixed(1)}</td>
					<td>${log.timestamp}</td>
					<td>${log.countdown !== undefined ? log.countdown.toFixed(1) : ''}</td>
					<td>${log.status || ''}</td>
				`;
				logTable.appendChild(row);
			});
		}

		const intersectionConfig = {
			Alpha: {
				intersection: "East",
				distance: 350,
				passDuration: 1
			},
			Beta: {
				intersection: "West",
				distance: 350,
				passDuration: 1
			}
		};

		const pathPoints = [
			{ x: 150, y: 500 }, { x: 170, y: 440 }, { x: 200, y: 370 },
			{ x: 240, y: 300 }, { x: 270, y: 240 }, { x: 285, y: 200 },
			{ x: 295, y: 185 }, { x: 305, y: 185 }, { x: 315, y: 200 },
			{ x: 330, y: 240 }, { x: 360, y: 300 }, { x: 400, y: 370 },
			{ x: 430, y: 440 }, { x: 450, y: 500 }, { x: 445, y: 515 },
			{ x: 410, y: 510 }, { x: 360, y: 490 }, { x: 340, y: 480 },
			{ x: 325, y: 475 }, { x: 315, y: 472 }, { x: 305, y: 470 },
			{ x: 295, y: 472 }, { x: 285, y: 475 }, { x: 270, y: 480 },
			{ x: 240, y: 490 }, { x: 190, y: 510 }, { x: 155, y: 515 },
			{ x: 150, y: 500 }
		];

		const checkpoints = [
			{ name: "Alpha", x: 300, y: 180 },
			{ name: "Beta", x: 300, y: 470 }
		];

		const intersections = [
			{ name: "East", x: 415, y: 400, svg: null },
			{ name: "West", x: 185, y: 400, svg: null }
		];

		const apiListUrl = 'https://script.google.com/macros/s/AKfycbzELXfSETWl3eC8D4hFBd5WUe6FkRbY_90FkZrNt7_mxzEl4RL4-SX_azeJt0NvP12z/exec';

		fetch(apiListUrl)
			.then(res => res.json())
			.then(apiArray => {
				const api_url_list = {};
				apiArray.forEach(api => {
					api_url_list[api.name] = api.url;
				});
				startWebSockets(api_url_list);
			})
			.catch(console.error);

		function startWebSockets(api_url_list) {
			const wsPosition = new WebSocket(`wss://${api_url_list.Train_Sim}/ws/position`);
			wsPosition.onmessage = event => {
				const msg = JSON.parse(event.data);
				if (msg.type === "position") {
					train.setAttribute("cx", msg.x);
					train.setAttribute("cy", msg.y);
					speedEl.textContent = msg.speed.toFixed(1);

					latestLogs["Position"] = {
						source: "Position",
						speed: msg.speed,
						timestamp: new Date().toLocaleTimeString()
					};
					updateLogTable();
				}
			};

			const wsCheckpoint = new WebSocket(`wss://${api_url_list.Train_Sim}/ws/checkpoint`);
			wsCheckpoint.onmessage = event => {
				const msg = JSON.parse(event.data);
				if (msg.type === "checkpoint") {
					flashCheckpoint(msg.name);

					if (!intersectionConfig[msg.name] || msg.speed <= 0) return;

					const { intersection, distance, passDuration } = intersectionConfig[msg.name];
					const inter = intersections.find(i => i.name === intersection);
					if (!inter) return;

					const timeToReach = distance / msg.speed;
					inter.svg.setAttribute("fill", "red");
					setTimeout(() => inter.svg.setAttribute("fill", "green"), (timeToReach + passDuration + 0.1) * 1000);

					latestLogs[msg.name] = {
						source: msg.name,
						speed: msg.speed,
						timestamp: new Date().toLocaleTimeString(),
						countdown: timeToReach,
						status: "RED"
					};
					updateLogTable();
				}
			};
		}

		pathPoints.slice(0, -1).forEach((a, i) => {
			const b = pathPoints[i + 1];
			const railroad = document.createElementNS("http://www.w3.org/2000/svg", "line");
			railroad.setAttribute("x1", a.x);
			railroad.setAttribute("y1", a.y);
			railroad.setAttribute("x2", b.x);
			railroad.setAttribute("y2", b.y);
			railroad.setAttribute("stroke", "#000");
			railroad.setAttribute("stroke-dasharray", "10");
			railroad.setAttribute("stroke-linecap", "round");
			railroad.setAttribute("stroke-width", 8);
			svg.appendChild(railroad);
		});

		const road = document.createElementNS("http://www.w3.org/2000/svg", "line");
		road.setAttribute("x1", 470);
		road.setAttribute("y1", 400);
		road.setAttribute("x2", 130);
		road.setAttribute("y2", 400);
		road.setAttribute("stroke", "#444");
		road.setAttribute("stroke-width", 4);
		road.setAttribute("stroke-linecap", "round");
		svg.appendChild(road);

		intersections.forEach(inter => {
			const marker = document.createElementNS("http://www.w3.org/2000/svg", "circle");
			marker.setAttribute("cx", inter.x);
			marker.setAttribute("cy", inter.y);
			marker.setAttribute("r", 5);
			marker.setAttribute("fill", "green");
			svg.appendChild(marker);
			inter.svg = marker;
		});

		checkpoints.forEach(cp => {
			const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
			circle.setAttribute("cx", cp.x);
			circle.setAttribute("cy", cp.y);
			circle.setAttribute("r", 10);
			circle.setAttribute("fill", "#cc0");
			circle.setAttribute("stroke", "#aa0");
			circle.setAttribute("stroke-width", 2);
			svg.appendChild(circle);

			const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
			label.setAttribute("x", cp.x + 12);
			label.setAttribute("y", cp.y - 12);
			label.textContent = cp.name;
			label.setAttribute("fill", "#333");
			label.setAttribute("font-size", "14px");
			label.setAttribute("font-family", "sans-serif");
			svg.appendChild(label);
		});

		const train = document.createElementNS("http://www.w3.org/2000/svg", "circle");
		train.setAttribute("r", 12);
		train.setAttribute("fill", "#007700");
		train.setAttribute("stroke", "#004400");
		train.setAttribute("stroke-width", 3);
		svg.appendChild(train);

		function flashCheckpoint(name) {
			const cp = checkpoints.find(c => c.name === name);
			if (!cp) return;
			svg.querySelectorAll("circle").forEach(c => {
				if (parseFloat(c.getAttribute("cx")) === cp.x && parseFloat(c.getAttribute("cy")) === cp.y) {
					const origFill = c.getAttribute("fill");
					c.setAttribute("fill", "red");
					setTimeout(() => c.setAttribute("fill", origFill), 700);
				}
			});
		}
	</script>
</body>
</html>
