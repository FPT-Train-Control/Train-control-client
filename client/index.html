<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Train Tracker</title>
	<style>
		body {
			font-family: sans-serif;
			text-align: center;
			background: #f4f4f4;
			margin: 0;
			padding: 0;
		}
		h1 {
			margin-top: 20px;
		}
		#svg {
			background: white;
			border: 1px solid #ccc;
			margin: 20px auto;
			display: block;
		}
		pre {
			background: #222;
			color: #0f0;
			padding: 10px;
			max-height: 200px;
			overflow-y: auto;
			text-align: left;
		}
	</style>
</head>
<body>
	<h1>Train Speed: <span id="speed">0</span> px/s</h1>
	<svg id="svg" width="600" height="600"></svg>
	<pre id="log"></pre>

	<script>
		const svg = document.getElementById("svg");
		const speedEl = document.getElementById("speed");
		const log = document.getElementById("log");

		const pathPoints = [
			{ x: 100, y: 100 },
			{ x: 300, y: 100 },
			{ x: 500, y: 300 },
			{ x: 300, y: 500 },
			{ x: 100, y: 300 },
			{ x: 100, y: 100 }
		];

		const checkpoints = [
			{ name: "Alpha", x: 300, y: 100 },
			{ name: "Beta", x: 300, y: 500 },
			{ name: "Gamma", x: 100, y: 300 }
		];

		// Draw path
		for (let i = 0; i < pathPoints.length - 1; i++) {
			const a = pathPoints[i];
			const b = pathPoints[i + 1];
			const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
			line.setAttribute("x1", a.x);
			line.setAttribute("y1", a.y);
			line.setAttribute("x2", b.x);
			line.setAttribute("y2", b.y);
			line.setAttribute("stroke", "#999");
			line.setAttribute("stroke-width", 4);
			svg.appendChild(line);
		}

		// Draw checkpoints
		checkpoints.forEach(cp => {
			const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
			circle.setAttribute("cx", cp.x);
			circle.setAttribute("cy", cp.y);
			circle.setAttribute("r", 10);
			circle.setAttribute("fill", "#cc0");
			circle.setAttribute("stroke", "#aa0");
			circle.setAttribute("stroke-width", 2);
			svg.appendChild(circle);

			const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
			label.setAttribute("x", cp.x + 12);
			label.setAttribute("y", cp.y - 12);
			label.textContent = cp.name;
			label.setAttribute("fill", "#333");
			label.setAttribute("font-size", "14px");
			label.setAttribute("font-family", "sans-serif");
			svg.appendChild(label);
		});

		// Train
		const train = document.createElementNS("http://www.w3.org/2000/svg", "circle");
		train.setAttribute("r", 12);
		train.setAttribute("fill", "#007700");
		train.setAttribute("stroke", "#004400");
		train.setAttribute("stroke-width", 3);
		svg.appendChild(train);

		// WebSocket for position
		const wsPosition = new WebSocket(`ws://${location.host}/ws/position`);
		wsPosition.onopen = () => logMessage("Position WebSocket connected.");
		wsPosition.onmessage = event => {
			const msg = JSON.parse(event.data);
			if (msg.type === "position") {
				train.setAttribute("cx", msg.x);
				train.setAttribute("cy", msg.y);
				speedEl.textContent = msg.speed.toFixed(1);
			}
		};
		wsPosition.onerror = () => logMessage("Error with position WebSocket.");
		wsPosition.onclose = () => logMessage("Position WebSocket closed.");

		// WebSocket for checkpoint
		const wsCheckpoint = new WebSocket(`ws://${location.host}/ws/checkpoint`);
		wsCheckpoint.onopen = () => logMessage("Checkpoint WebSocket connected.");
		wsCheckpoint.onmessage = event => {
			const msg = JSON.parse(event.data);
			if (msg.type === "checkpoint") {
				logMessage(`Checkpoint hit: ${msg.name} at speed ${msg.speed.toFixed(1)}`);
				flashCheckpoint(msg.name);
			}
		};
		wsCheckpoint.onerror = () => logMessage("Error with checkpoint WebSocket.");
		wsCheckpoint.onclose = () => logMessage("Checkpoint WebSocket closed.");

		function logMessage(text) {
			const time = new Date().toLocaleTimeString();
			log.textContent += `[${time}] ${text}\n`;
			log.scrollTop = log.scrollHeight;
		}

		function flashCheckpoint(name) {
			const cp = checkpoints.find(c => c.name === name);
			if (!cp) return;
			const circles = svg.querySelectorAll("circle");
			circles.forEach(c => {
				if (parseFloat(c.getAttribute("cx")) === cp.x && parseFloat(c.getAttribute("cy")) === cp.y) {
					const origFill = c.getAttribute("fill");
					c.setAttribute("fill", "red");
					setTimeout(() => c.setAttribute("fill", origFill), 700);
				}
			});
		}
	</script>
</body>
</html>
